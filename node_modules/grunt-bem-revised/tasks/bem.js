/*
 * grunt-bem-revised
 * https://github.com/verybigman/grunt-bem-revised
 */

'use strict';

module.exports = function (grunt) {

    var resolve = require('path').resolve.bind(process.cwd()),
        requireResolve = function (module) {
            var start = module.substr(0, 2);
            return (start !== './' && start !== '..') ? module : resolve(module);
        },
        extend = grunt.util._.extend;

    grunt.registerMultiTask('bem', 'bem-tools methods from Grunt', function () {

        var options = extend({
                require: 'bem', // Resolve with bem-cli
                TARGETS: this.data.target
            }, this.options(), this.data), done = this.async();

        var command = this.data.command !== undefined ? this.data.command : "make",
            sub = this.data.sub;

        var B = require(requireResolve(options.require)),
            Q = B.require('q'),
            BEM = B.api;


        // TODO: Need refactoring...
        if (sub) {
            Q.when(BEM[command][sub](options), done, function (err) {
                grunt.log.error(err);
                done(false);
            });
        }
        else {
            Q.when(BEM[command](options), done, function (err) {
                grunt.log.error(err);
                done(false);
            });
        }
    });

};
